'use strict';(function(n){"object"==typeof exports&&"object"==typeof module?n(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],n):n(CodeMirror)})(function(n){function A(a,c){this.mv=a;this.type=c;this.classes="left"==c?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:
{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function z(a){a.diffOutOfDate&&(a.diff=L(a.orig.getValue(),a.edit.getValue()),a.chunks=M(a.diff),a.diffOutOfDate=!1,n.signal(a.edit,"updateDiff",a.diff))}function aa(a){function c(b){B=!0;h=!1;"full"==b&&(a.svg&&C(a.svg),a.copyButtons&&C(a.copyButtons),G(a.edit,e.marked,a.classes),G(a.orig,
k.marked,a.classes),e.from=e.to=k.from=k.to=0);z(a);a.showDifferences&&(N(a.edit,a.diff,e,DIFF_INSERT,a.classes),N(a.orig,a.diff,k,DIFF_DELETE,a.classes));x(a);"align"==a.mv.options.connect&&H(a);B=!1}function b(b){B||(a.dealigned=!0,d(b))}function d(a){B||h||(clearTimeout(g),!0===a&&(h=!0),g=setTimeout(c,!0===a?20:250))}function f(c,d){a.diffOutOfDate||(a.diffOutOfDate=!0,e.from=e.to=k.from=k.to=0);b(d.text.length-1!=d.to.line-d.from.line)}var e={from:0,to:0,marked:[]},k={from:0,to:0,marked:[]},
g,h=!1;a.edit.on("change",f);a.orig.on("change",f);a.edit.on("markerAdded",b);a.edit.on("markerCleared",b);a.orig.on("markerAdded",b);a.orig.on("markerCleared",b);a.edit.on("viewportChange",function(){d(!1)});a.orig.on("viewportChange",function(){d(!1)});c();return c}function ba(a){a.edit.on("scroll",function(){I(a,DIFF_INSERT)&&x(a)});a.orig.on("scroll",function(){I(a,DIFF_DELETE)&&x(a)})}function I(a,c){var b,d;if(a.diffOutOfDate)return!1;if(!a.lockScroll)return!0;var f,e,k=+new Date;c==DIFF_INSERT?
(f=a.edit,e=a.orig):(f=a.orig,e=a.edit);if(f.state.scrollSetBy==a&&(f.state.scrollSetAt||0)+50>k)return!1;var g=f.getScrollInfo();if("align"==a.mv.options.connect)l=g.top;else{var h=.5*g.clientHeight,l=g.top+h;b=f.lineAtHeight(l,"local");for(var m=a.chunks,n=c==DIFF_INSERT,u,t,p,r=0;r<m.length;r++){var v=m[r],O=n?v.editFrom:v.origFrom,q=n?v.editTo:v.origTo;null==t&&(O>b?(t=v.editFrom,p=v.origFrom):q>b&&(t=v.editTo,p=v.origTo));q<=b?(u=v.editTo,d=v.origTo):O<=b&&(u=v.editFrom,d=v.origFrom)}b={before:u,
after:t};d={before:d,after:p};f=P(f,c==DIFF_INSERT?b:d);d=P(e,c==DIFF_INSERT?d:b);var l=d.top-h+(l-f.top)/(f.bot-f.top)*(d.bot-d.top),y;l>g.top&&1>(y=g.top/h)?l=l*y+g.top*(1-y):(f=g.height-g.clientHeight-g.top)<h&&(d=e.getScrollInfo(),d.height-d.clientHeight-l>f&&1>(y=f/h)&&(l=l*y+(d.height-d.clientHeight-f)*(1-y)))}e.scrollTo(g.left,l);e.state.scrollSetAt=k;e.state.scrollSetBy=a;return!0}function P(a,c){var b=c.after;null==b&&(b=a.lastLine()+1);return{top:a.heightAtLine(c.before||0,"local"),bot:a.heightAtLine(b,
"local")}}function Q(a,c,b){(a.lockScroll=c)&&0!=b&&I(a,DIFF_INSERT)&&x(a);a.lockButton.innerHTML=c?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function G(a,c,b){for(var d=0;d<c.length;++d){var f=c[d];f instanceof n.TextMarker?f.clear():f.parent&&(a.removeLineClass(f,"background",b.chunk),a.removeLineClass(f,"background",b.start),a.removeLineClass(f,"background",b.end))}c.length=0}function N(a,c,b,d,f){var e=a.getViewport();a.operation(function(){b.from==b.to||20<e.from-b.to||20<b.from-e.to?(G(a,b.marked,
f),J(a,c,d,b.marked,e.from,e.to,f),b.from=e.from,b.to=e.to):(e.from<b.from&&(J(a,c,d,b.marked,e.from,b.from,f),b.from=e.from),e.to>b.to&&(J(a,c,d,b.marked,b.to,e.to,f),b.to=e.to))})}function J(a,c,b,d,f,e,k){function g(b,c){for(var g=Math.max(f,b),h=Math.min(e,c),l=g;l<h;++l){var m=a.addLineClass(l,"background",k.chunk);l==b&&a.addLineClass(m,"background",k.start);l==c-1&&a.addLineClass(m,"background",k.end);d.push(m)}b==c&&g==c&&h==c&&(g?d.push(a.addLineClass(g-1,"background",k.end)):d.push(a.addLineClass(g,
"background",k.start)))}for(var h=q(0,0),l=q(f,0),m=a.clipPos(q(e-1)),n=b==DIFF_DELETE?k.del:k.insert,u=0,t=0;t<c.length;++t){var p=c[t],r=p[0],p=p[1];r==DIFF_EQUAL?(r=h.line+(R(c,t)?0:1),D(h,p),p=h.line+(S(c,t)?1:0),p>r&&(t&&g(u,r),u=p)):r==b&&(r=D(h,p,!0),h=0<(l.line-h.line||l.ch-h.ch)?l:h,p=0>(m.line-r.line||m.ch-r.ch)?m:r,h.line==p.line&&h.ch==p.ch||d.push(a.markText(h,p,{className:n})),h=r)}u<=h.line&&g(u,h.line+1)}function x(a){if(a.showDifferences){if(a.svg){C(a.svg);var c=a.gap.offsetWidth;
T(a.svg,"width",c,"height",a.gap.offsetHeight)}a.copyButtons&&C(a.copyButtons);for(var b=a.edit.getViewport(),d=a.orig.getViewport(),f=a.edit.getScrollInfo().top,e=a.orig.getScrollInfo().top,k=0;k<a.chunks.length;k++){var g=a.chunks[k];if(g.editFrom<=b.to&&g.editTo>=b.from&&g.origFrom<=d.to&&g.origTo>=d.from){var h=a,l=e,m=f,n=c,u="left"==h.type,t=h.orig.heightAtLine(g.origFrom,"local")-l;if(h.svg){var p=t,r=h.edit.heightAtLine(g.editFrom,"local")-m;if(u)var v=p,p=r,r=v;var l=h.orig.heightAtLine(g.origTo,
"local")-l,q=h.edit.heightAtLine(g.editTo,"local")-m;u&&(v=l,l=q,q=v);u=" C "+n/2+" "+r+" "+n/2+" "+p+" "+(n+2)+" "+p;p=" C "+n/2+" "+l+" "+n/2+" "+q+" -1 "+q;T(h.svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")),"d","M -1 "+r+u+" L "+(n+2)+" "+l+p+" z","class",h.classes.connect)}h.copyButtons&&(n=h.copyButtons.appendChild(w("div","left"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy")),r=h.mv.options.allowEditingOriginals,n.title=r?"Push to left":"Revert chunk",n.chunk=
g,n.style.top=t+"px",r&&(m=h.orig.heightAtLine(g.editFrom,"local")-m,t=h.copyButtons.appendChild(w("div","right"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse")),t.title="Push to right",t.chunk={editFrom:g.origFrom,editTo:g.origTo,origFrom:g.editFrom,origTo:g.editTo},t.style.top=m+"px","right"==h.type?t.style.left="2px":t.style.right="2px"))}}}}function E(a,c){for(var b=0,d=0,f=0;f<c.length;f++){var e=c[f];if(e.editTo>a&&e.editFrom<=a)return null;if(e.editFrom>a)break;b=e.editTo;d=e.origTo}return d+
(a-b)}function ca(a,c){for(var b=[],d=0;d<a.chunks.length;d++){var f=a.chunks[d];b.push([f.origTo,f.editTo,c?E(f.editTo,c.chunks):null])}if(c)for(d=0;d<c.chunks.length;d++){for(var f=c.chunks[d],e=0;e<b.length;e++){var k=b[e];if(k[1]==f.editTo){e=-1;break}else if(k[1]>f.editTo)break}-1<e&&b.splice(e-1,0,[E(f.editTo,a.chunks),f.editTo,f.origTo])}return b}function H(a,c){if(a.dealigned||c){if(!a.orig.curOp)return a.orig.operation(function(){H(a,c)});a.dealigned=!1;var b=a.mv.left==a?a.mv.right:a.mv.left;
b&&(z(b),b.dealigned=!1);for(var d=ca(a,b),f=a.mv.aligners,e=0;e<f.length;e++)f[e].clear();f.length=0;var k=[a.orig,a.edit],g=[];b&&k.push(b.orig);for(e=0;e<k.length;e++)g.push(k[e].getScrollInfo().top);for(b=0;b<d.length;b++)da(k,d[b],f);for(e=0;e<k.length;e++)k[e].scrollTo(null,g[e])}}function da(a,c,b){for(var d=0,f=[],e=0;e<a.length;e++)if(null!=c[e]){var k=a[e].heightAtLine(c[e],"local");f[e]=k;d=Math.max(d,k)}for(e=0;e<a.length;e++)null!=c[e]&&(k=d-f[e],1<k&&b.push(ea(a[e],c[e],k)))}function ea(a,
c,b){var d=!0;c>a.lastLine()&&(c--,d=!1);var f=document.createElement("div");f.className="CodeMirror-merge-spacer";f.style.height=b+"px";f.style.minWidth="1px";return a.addLineWidget(c,f,{height:b,above:d})}function U(a,c,b,d){if(!a.diffOutOfDate){a=d.editTo>c.lastLine()?q(d.editFrom-1):q(d.editFrom,0);var f=d.origTo>b.lastLine()?q(d.origFrom-1):q(d.origFrom,0);c.replaceRange(b.getRange(f,q(d.origTo,0)),a,q(d.editTo,0))}}function V(a){var c=a.lockButton=w("div",null,"CodeMirror-merge-scrolllock");
c.title="Toggle locked scrolling";var b=w("div",[c],"CodeMirror-merge-scrolllock-wrap");n.on(c,"click",function(){Q(a,!a.lockScroll)});c=[b];!1!==a.mv.options.revertButtons&&(a.copyButtons=w("div",null,"CodeMirror-merge-copybuttons-"+a.type),n.on(a.copyButtons,"click",function(b){b=b.target||b.srcElement;b.chunk&&("CodeMirror-merge-copy-reverse"==b.className?U(a,a.orig,a.edit,b.chunk):U(a,a.edit,a.orig,b.chunk))}),c.unshift(a.copyButtons));"align"!=a.mv.options.connect&&((b=document.createElementNS&&
document.createElementNS("http://www.w3.org/2000/svg","svg"))&&!b.createSVGRect&&(b=null),(a.svg=b)&&c.push(b));return a.gap=w("div",c,"CodeMirror-merge-gap")}function W(a){return"string"==typeof a?a:a.getValue()}function L(a,c){var b=X.diff_main(a,c);X.diff_cleanupSemantic(b);for(var d=0;d<b.length;++d){var f=b[d];f[1]?d&&b[d-1][0]==f[0]&&(b.splice(d--,1),b[d][1]+=f[1]):b.splice(d--,1)}return b}function M(a){for(var c=[],b=0,d=0,f=q(0,0),e=q(0,0),k=0;k<a.length;++k){var g=a[k],h=g[0];if(h==DIFF_EQUAL){var l=
R(a,k)?0:1,h=f.line+l,l=e.line+l;D(f,g[1],null,e);var m=S(a,k)?1:0,g=f.line+m,m=e.line+m;g>h&&(k&&c.push({origFrom:d,origTo:l,editFrom:b,editTo:h}),b=g,d=m)}else D(h==DIFF_INSERT?f:e,g[1])}(b<=f.line||d<=e.line)&&c.push({origFrom:d,origTo:e.line+1,editFrom:b,editTo:f.line+1});return c}function S(a,c){if(c==a.length-1)return!0;var b=a[c+1][1];if(1==b.length||10!=b.charCodeAt(0))return!1;if(c==a.length-2)return!0;b=a[c+2][1];return 1<b.length&&10==b.charCodeAt(0)}function R(a,c){if(0==c)return!0;var b=
a[c-1][1];if(10!=b.charCodeAt(b.length-1))return!1;if(1==c)return!0;b=a[c-2][1];return 10==b.charCodeAt(b.length-1)}function fa(a,c,b){function d(){e.clear();a.removeLineClass(c,"wrap","CodeMirror-merge-collapsed-line")}a.addLineClass(c,"wrap","CodeMirror-merge-collapsed-line");var f=document.createElement("span");f.className="CodeMirror-merge-collapsed-widget";f.title="Identical text collapsed. Click to expand.";var e=a.markText(q(c,0),q(b-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:f,clearOnEnter:!0});
n.on(f,"click",d);return{mark:e,clear:d}}function ga(a,c){function b(){for(var a=0;a<d.length;a++)d[a].clear()}for(var d=[],f=0;f<c.length;f++){var e=c[f],e=fa(e.cm,e.line,e.line+a);d.push(e);e.mark.on("clear",b)}return d[0].mark}function Y(a,c,b,d){for(var f=0;f<a.chunks.length;f++)for(var e=a.chunks[f],k=e.editFrom-c;k<e.editTo+c;k++){var g=k+b;0<=g&&g<d.length&&(d[g]=!1)}}function w(a,c,b,d){a=document.createElement(a);b&&(a.className=b);d&&(a.style.cssText=d);if("string"==typeof c)a.appendChild(document.createTextNode(c));
else if(c)for(b=0;b<c.length;++b)a.appendChild(c[b]);return a}function C(a){for(var c=a.childNodes.length;0<c;--c)a.removeChild(a.firstChild)}function T(a){for(var c=1;c<arguments.length;c+=2)a.setAttribute(arguments[c],arguments[c+1])}function K(a,c){c||(c={});for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}function D(a,c,b,d){a=b?q(a.line,a.ch):a;for(b=0;;){var f=c.indexOf("\n",b);if(-1==f)break;++a.line;d&&++d.line;b=f+1}a.ch=(b?0:a.ch)+(c.length-b);d&&(d.ch=(b?0:d.ch)+(c.length-b));return a}
function Z(a,c){var b=null,d=a.state.diffViews,f=a.getCursor().line;if(d)for(var e=0;e<d.length;e++){var k=d[e],g=a==k.orig;z(k);if(0>c)a:{for(var k=k.chunks,h=k.length-1;0<=h;h--){var l=k[h],l=(g?l.origTo:l.editTo)-1;if(l<f){g=l;break a}}g=void 0}else a:{k=k.chunks;for(h=0;h<k.length;h++)if(l=k[h],l=g?l.origFrom:l.editFrom,l>f){g=l;break a}g=void 0}null!=g&&(null==b||(0>c?g>b:g<b))&&(b=g)}if(null!=b)a.setCursor(b,0);else return n.Pass}var q=n.Pos;A.prototype={constructor:A,init:function(a,c,b){this.edit=
this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=n(a,K({value:c,readOnly:!this.mv.options.allowEditingOriginals},K(b)));this.orig.state.diffViews=[this];this.diff=L(W(c),W(b.value));this.chunks=M(this.diff);this.diffOutOfDate=this.dealigned=!1;this.showDifferences=!1!==b.showDifferences;this.forceUpdate=aa(this);Q(this,!0,!1);ba(this)},setShowDifferences:function(a){a=!1!==a;a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var B=
!1,F=n.MergeView=function(a,c){if(!(this instanceof F))return new F(a,c);this.options=c;var b=c.origLeft,d=null==c.origRight?c.orig:c.origRight,f=null!=b,e=null!=d,k=1+(f?1:0)+(e?1:0),g=[],h=this.left=null,l=this.right=null,m=this;if(f){var h=this.left=new A(this,"left"),q=w("div",null,"CodeMirror-merge-pane");g.push(q);g.push(V(h))}f=w("div",null,"CodeMirror-merge-pane");g.push(f);if(e){l=this.right=new A(this,"right");g.push(V(l));var u=w("div",null,"CodeMirror-merge-pane");g.push(u)}(e?u:f).className+=
" CodeMirror-merge-pane-rightmost";g.push(w("div",null,null,"height: 0; clear: both;"));var t=this.wrap=a.appendChild(w("div",g,"CodeMirror-merge CodeMirror-merge-"+k+"pane"));this.edit=n(f,K(c));h&&h.init(q,b,c);l&&l.init(u,d,c);c.collapseIdentical&&this.editor().operation(function(){var a=c.collapseIdentical;"number"!=typeof a&&(a=2);for(var b=[],d=m.editor(),f=d.firstLine(),e=f,g=d.lastLine();e<=g;e++)b.push(!0);m.left&&Y(m.left,a,f,b);m.right&&Y(m.right,a,f,b);for(e=0;e<b.length;e++)if(b[e]){for(var g=
e+f,h=1;e<b.length-1&&b[e+1];e++,h++);if(h>a){var k=[{line:g,cm:d}];m.left&&k.push({line:E(g,m.left.chunks),cm:m.left.orig});m.right&&k.push({line:E(g,m.right.chunks),cm:m.right.orig});k=ga(h,k);if(m.options.onCollapse)m.options.onCollapse(m,g,h,k)}}});"align"==c.connect&&(this.aligners=[],H(this.left||this.right,!0));var p=function(){h&&x(h);l&&x(l)};n.on(window,"resize",p);var r=setInterval(function(){for(var a=t.parentNode;a&&a!=document.body;a=a.parentNode);a||(clearInterval(r),n.off(window,"resize",
p))},5E3)};F.prototype={constuctor:F,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a);this.left&&this.left.setShowDifferences(a)},rightChunks:function(){if(this.right)return z(this.right),this.right.chunks},leftChunks:function(){if(this.left)return z(this.left),this.left.chunks}};var X=new diff_match_patch;n.commands.goNextDiff=
function(a){return Z(a,1)};n.commands.goPrevDiff=function(a){return Z(a,-1)}});
