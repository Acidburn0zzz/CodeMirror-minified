'use strict';(function(m){"object"==typeof exports&&"object"==typeof module?m(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],m):m(CodeMirror)})(function(m){function A(a,b){this.mv=a;this.type=b;this.classes="left"==b?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:
{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"}}function z(a){a.diffOutOfDate&&(a.diff=M(a.orig.getValue(),a.edit.getValue()),a.chunks=N(a.diff),a.diffOutOfDate=!1,m.signal(a.edit,"updateDiff",a.diff))}function ba(a){function b(b){B=!0;h=!1;"full"==b&&(a.svg&&C(a.svg),a.copyButtons&&C(a.copyButtons),G(a.edit,d.marked,a.classes),G(a.orig,
k.marked,a.classes),d.from=d.to=k.from=k.to=0);z(a);a.showDifferences&&(O(a.edit,a.diff,d,DIFF_INSERT,a.classes),O(a.orig,a.diff,k,DIFF_DELETE,a.classes));x(a);"align"==a.mv.options.connect&&H(a);B=!1}function c(b){B||(a.dealigned=!0,f(b))}function f(a){B||h||(clearTimeout(g),!0===a&&(h=!0),g=setTimeout(b,!0===a?20:250))}function e(b,e){a.diffOutOfDate||(a.diffOutOfDate=!0,d.from=d.to=k.from=k.to=0);c(e.text.length-1!=e.to.line-e.from.line)}var d={from:0,to:0,marked:[]},k={from:0,to:0,marked:[]},
g,h=!1;a.edit.on("change",e);a.orig.on("change",e);a.edit.on("markerAdded",c);a.edit.on("markerCleared",c);a.orig.on("markerAdded",c);a.orig.on("markerCleared",c);a.edit.on("viewportChange",function(){f(!1)});a.orig.on("viewportChange",function(){f(!1)});b();return b}function ca(a){a.edit.on("scroll",function(){I(a,DIFF_INSERT)&&x(a)});a.orig.on("scroll",function(){I(a,DIFF_DELETE)&&x(a)})}function I(a,b){var c,f;if(a.diffOutOfDate)return!1;if(!a.lockScroll)return!0;var e,d,k=+new Date;b==DIFF_INSERT?
(e=a.edit,d=a.orig):(e=a.orig,d=a.edit);if(e.state.scrollSetBy==a&&(e.state.scrollSetAt||0)+50>k)return!1;var g=e.getScrollInfo();if("align"==a.mv.options.connect)l=g.top;else{var h=.5*g.clientHeight,l=g.top+h;c=e.lineAtHeight(l,"local");for(var n=a.chunks,m=b==DIFF_INSERT,u,t,p,r=0;r<n.length;r++){var v=n[r],P=m?v.editFrom:v.origFrom,q=m?v.editTo:v.origTo;null==t&&(P>c?(t=v.editFrom,p=v.origFrom):q>c&&(t=v.editTo,p=v.origTo));q<=c?(u=v.editTo,f=v.origTo):P<=c&&(u=v.editFrom,f=v.origFrom)}c={before:u,
after:t};f={before:f,after:p};e=Q(e,b==DIFF_INSERT?c:f);b=Q(d,b==DIFF_INSERT?f:c);var l=b.top-h+(l-e.top)/(e.bot-e.top)*(b.bot-b.top),y;l>g.top&&1>(y=g.top/h)?l=l*y+g.top*(1-y):(b=g.height-g.clientHeight-g.top)<h&&(e=d.getScrollInfo(),e.height-e.clientHeight-l>b&&1>(y=b/h)&&(l=l*y+(e.height-e.clientHeight-b)*(1-y)))}d.scrollTo(g.left,l);d.state.scrollSetAt=k;d.state.scrollSetBy=a;return!0}function Q(a,b){var c=b.after;null==c&&(c=a.lastLine()+1);return{top:a.heightAtLine(b.before||0,"local"),bot:a.heightAtLine(c,
"local")}}function R(a,b,c){(a.lockScroll=b)&&0!=c&&I(a,DIFF_INSERT)&&x(a);a.lockButton.innerHTML=b?"\u21db\u21da":"\u21db&nbsp;&nbsp;\u21da"}function G(a,b,c){for(var f=0;f<b.length;++f){var e=b[f];if(e instanceof m.TextMarker)e.clear();else if(e.parent)for(var d=a,k=c,g=k.classLocation,h=0;h<g.length;h++)d.removeLineClass(e,g[h],k.chunk),d.removeLineClass(e,g[h],k.start),d.removeLineClass(e,g[h],k.chunk)}b.length=0}function O(a,b,c,f,e){var d=a.getViewport();a.operation(function(){c.from==c.to||
20<d.from-c.to||20<c.from-d.to?(G(a,c.marked,e),J(a,b,f,c.marked,d.from,d.to,e),c.from=d.from,c.to=d.to):(d.from<c.from&&(J(a,b,f,c.marked,d.from,c.from,e),c.from=d.from),d.to>c.to&&(J(a,b,f,c.marked,c.to,d.to,e),c.to=d.to))})}function K(a,b,c,f,e,d){var k=c.classLocation;b=a.getLineHandle(b);for(var g=0;g<k.length;g++)f&&a.addLineClass(b,k[g],c.chunk),e&&a.addLineClass(b,k[g],c.start),d&&a.addLineClass(b,k[g],c.end);return b}function J(a,b,c,f,e,d,k){function g(b,c){for(var g=Math.max(e,b),h=Math.min(d,
c),l=g;l<h;++l)f.push(K(a,l,k,!0,l==b,l==c-1));b==c&&g==c&&h==c&&(g?f.push(K(a,g-1,k,!1,!1,!0)):f.push(K(a,g,k,!1,!0,!1)))}for(var h=q(0,0),l=q(e,0),n=a.clipPos(q(d-1)),m=c==DIFF_DELETE?k.del:k.insert,u=0,t=0;t<b.length;++t){var p=b[t],r=p[0],p=p[1];r==DIFF_EQUAL?(r=h.line+(S(b,t)?0:1),D(h,p),p=h.line+(T(b,t)?1:0),p>r&&(t&&g(u,r),u=p)):r==c&&(r=D(h,p,!0),h=0<(l.line-h.line||l.ch-h.ch)?l:h,p=0>(n.line-r.line||n.ch-r.ch)?n:r,h.line==p.line&&h.ch==p.ch||f.push(a.markText(h,p,{className:m})),h=r)}u<=
h.line&&g(u,h.line+1)}function x(a){if(a.showDifferences){if(a.svg){C(a.svg);var b=a.gap.offsetWidth;U(a.svg,"width",b,"height",a.gap.offsetHeight)}a.copyButtons&&C(a.copyButtons);for(var c=a.edit.getViewport(),f=a.orig.getViewport(),e=a.mv.wrap.getBoundingClientRect().top,d=e-a.edit.getScrollerElement().getBoundingClientRect().top+a.edit.getScrollInfo().top,e=e-a.orig.getScrollerElement().getBoundingClientRect().top+a.orig.getScrollInfo().top,k=0;k<a.chunks.length;k++){var g=a.chunks[k];if(g.editFrom<=
c.to&&g.editTo>=c.from&&g.origFrom<=f.to&&g.origTo>=f.from){var h=a,l=e,n=d,m=b,u="left"==h.type,t=h.orig.heightAtLine(g.origFrom,"local")-l;if(h.svg){var p=t,r=h.edit.heightAtLine(g.editFrom,"local")-n;if(u)var v=p,p=r,r=v;var l=h.orig.heightAtLine(g.origTo,"local")-l,q=h.edit.heightAtLine(g.editTo,"local")-n;u&&(v=l,l=q,q=v);u=" C "+m/2+" "+r+" "+m/2+" "+p+" "+(m+2)+" "+p;p=" C "+m/2+" "+l+" "+m/2+" "+q+" -1 "+q;U(h.svg.appendChild(document.createElementNS("http://www.w3.org/2000/svg","path")),
"d","M -1 "+r+u+" L "+(m+2)+" "+l+p+" z","class",h.classes.connect)}h.copyButtons&&(m=h.copyButtons.appendChild(w("div","left"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy")),r=h.mv.options.allowEditingOriginals,m.title=r?"Push to left":"Revert chunk",m.chunk=g,m.style.top=t+"px",r&&(n=h.orig.heightAtLine(g.editFrom,"local")-n,t=h.copyButtons.appendChild(w("div","right"==h.type?"\u21dd":"\u21dc","CodeMirror-merge-copy-reverse")),t.title="Push to right",t.chunk={editFrom:g.origFrom,editTo:g.origTo,
origFrom:g.editFrom,origTo:g.editTo},t.style.top=n+"px","right"==h.type?t.style.left="2px":t.style.right="2px"))}}}}function E(a,b){for(var c=0,f=0,e=0;e<b.length;e++){var d=b[e];if(d.editTo>a&&d.editFrom<=a)return null;if(d.editFrom>a)break;c=d.editTo;f=d.origTo}return f+(a-c)}function da(a,b){for(var c=[],f=0;f<a.chunks.length;f++){var e=a.chunks[f];c.push([e.origTo,e.editTo,b?E(e.editTo,b.chunks):null])}if(b)for(f=0;f<b.chunks.length;f++){for(var e=b.chunks[f],d=0;d<c.length;d++){var k=c[d];if(k[1]==
e.editTo){d=-1;break}else if(k[1]>e.editTo)break}-1<d&&c.splice(d-1,0,[E(e.editTo,a.chunks),e.editTo,e.origTo])}return c}function H(a,b){if(a.dealigned||b){if(!a.orig.curOp)return a.orig.operation(function(){H(a,b)});a.dealigned=!1;var c=a.mv.left==a?a.mv.right:a.mv.left;c&&(z(c),c.dealigned=!1);for(var f=da(a,c),e=a.mv.aligners,d=0;d<e.length;d++)e[d].clear();e.length=0;var k=[a.orig,a.edit],g=[];c&&k.push(c.orig);for(d=0;d<k.length;d++)g.push(k[d].getScrollInfo().top);for(c=0;c<f.length;c++)ea(k,
f[c],e);for(d=0;d<k.length;d++)k[d].scrollTo(null,g[d])}}function ea(a,b,c){for(var f=0,e=[],d=0;d<a.length;d++)if(null!=b[d]){var k=a[d].heightAtLine(b[d],"local");e[d]=k;f=Math.max(f,k)}for(d=0;d<a.length;d++)null!=b[d]&&(k=f-e[d],1<k&&c.push(fa(a[d],b[d],k)))}function fa(a,b,c){var f=!0;b>a.lastLine()&&(b--,f=!1);var e=document.createElement("div");e.className="CodeMirror-merge-spacer";e.style.height=c+"px";e.style.minWidth="1px";return a.addLineWidget(b,e,{height:c,above:f})}function V(a,b,c,
f){if(!a.diffOutOfDate){a=f.editTo>b.lastLine()?q(f.editFrom-1):q(f.editFrom,0);var e=f.origTo>c.lastLine()?q(f.origFrom-1):q(f.origFrom,0);b.replaceRange(c.getRange(e,q(f.origTo,0)),a,q(f.editTo,0))}}function W(a){var b=a.lockButton=w("div",null,"CodeMirror-merge-scrolllock");b.title="Toggle locked scrolling";var c=w("div",[b],"CodeMirror-merge-scrolllock-wrap");m.on(b,"click",function(){R(a,!a.lockScroll)});b=[c];!1!==a.mv.options.revertButtons&&(a.copyButtons=w("div",null,"CodeMirror-merge-copybuttons-"+
a.type),m.on(a.copyButtons,"click",function(b){b=b.target||b.srcElement;b.chunk&&("CodeMirror-merge-copy-reverse"==b.className?V(a,a.orig,a.edit,b.chunk):V(a,a.edit,a.orig,b.chunk))}),b.unshift(a.copyButtons));"align"!=a.mv.options.connect&&((c=document.createElementNS&&document.createElementNS("http://www.w3.org/2000/svg","svg"))&&!c.createSVGRect&&(c=null),(a.svg=c)&&b.push(c));return a.gap=w("div",b,"CodeMirror-merge-gap")}function X(a){return"string"==typeof a?a:a.getValue()}function M(a,b){a=
Y.diff_main(a,b);Y.diff_cleanupSemantic(a);for(b=0;b<a.length;++b){var c=a[b];c[1]?b&&a[b-1][0]==c[0]&&(a.splice(b--,1),a[b][1]+=c[1]):a.splice(b--,1)}return a}function N(a){for(var b=[],c=0,f=0,e=q(0,0),d=q(0,0),k=0;k<a.length;++k){var g=a[k],h=g[0];if(h==DIFF_EQUAL){var l=S(a,k)?0:1,h=e.line+l,l=d.line+l;D(e,g[1],null,d);var m=T(a,k)?1:0,g=e.line+m,m=d.line+m;g>h&&(k&&b.push({origFrom:f,origTo:l,editFrom:c,editTo:h}),c=g,f=m)}else D(h==DIFF_INSERT?e:d,g[1])}(c<=e.line||f<=d.line)&&b.push({origFrom:f,
origTo:d.line+1,editFrom:c,editTo:e.line+1});return b}function T(a,b){if(b==a.length-1)return!0;var c=a[b+1][1];if(1==c.length||10!=c.charCodeAt(0))return!1;if(b==a.length-2)return!0;c=a[b+2][1];return 1<c.length&&10==c.charCodeAt(0)}function S(a,b){if(0==b)return!0;var c=a[b-1][1];if(10!=c.charCodeAt(c.length-1))return!1;if(1==b)return!0;c=a[b-2][1];return 10==c.charCodeAt(c.length-1)}function ga(a,b,c){function f(){d.clear();a.removeLineClass(b,"wrap","CodeMirror-merge-collapsed-line")}a.addLineClass(b,
"wrap","CodeMirror-merge-collapsed-line");var e=document.createElement("span");e.className="CodeMirror-merge-collapsed-widget";e.title="Identical text collapsed. Click to expand.";var d=a.markText(q(b,0),q(c-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:e,clearOnEnter:!0});m.on(e,"click",f);return{mark:d,clear:f}}function ha(a,b){function c(){for(var a=0;a<f.length;a++)f[a].clear()}for(var f=[],e=0;e<b.length;e++){var d=b[e],d=ga(d.cm,d.line,d.line+a);f.push(d);d.mark.on("clear",c)}return f[0].mark}
function Z(a,b,c,f){for(var e=0;e<a.chunks.length;e++)for(var d=a.chunks[e],k=d.editFrom-b;k<d.editTo+b;k++){var g=k+c;0<=g&&g<f.length&&(f[g]=!1)}}function w(a,b,c,f){a=document.createElement(a);c&&(a.className=c);f&&(a.style.cssText=f);if("string"==typeof b)a.appendChild(document.createTextNode(b));else if(b)for(c=0;c<b.length;++c)a.appendChild(b[c]);return a}function C(a){for(var b=a.childNodes.length;0<b;--b)a.removeChild(a.firstChild)}function U(a){for(var b=1;b<arguments.length;b+=2)a.setAttribute(arguments[b],
arguments[b+1])}function L(a,b){b||(b={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function D(a,b,c,f){a=c?q(a.line,a.ch):a;for(c=0;;){var e=b.indexOf("\n",c);if(-1==e)break;++a.line;f&&++f.line;c=e+1}a.ch=(c?0:a.ch)+(b.length-c);f&&(f.ch=(c?0:f.ch)+(b.length-c));return a}function aa(a,b){var c=null,f=a.state.diffViews,e=a.getCursor().line;if(f)for(var d=0;d<f.length;d++){var k=f[d],g=a==k.orig;z(k);if(0>b)a:{for(var k=k.chunks,h=k.length-1;0<=h;h--){var l=k[h],l=(g?l.origTo:l.editTo)-
1;if(l<e){g=l;break a}}g=void 0}else a:{k=k.chunks;for(h=0;h<k.length;h++)if(l=k[h],l=g?l.origFrom:l.editFrom,l>e){g=l;break a}g=void 0}null!=g&&(null==c||(0>b?g>c:g<c))&&(c=g)}if(null!=c)a.setCursor(c,0);else return m.Pass}var q=m.Pos;A.prototype={constructor:A,init:function(a,b,c){this.edit=this.mv.edit;(this.edit.state.diffViews||(this.edit.state.diffViews=[])).push(this);this.orig=m(a,L({value:b,readOnly:!this.mv.options.allowEditingOriginals},L(c)));this.orig.state.diffViews=[this];a=c.chunkClassLocation||
"background";"[object Array]"!=Object.prototype.toString.call(a)&&(a=[a]);this.classes.classLocation=a;this.diff=M(X(b),X(c.value));this.chunks=N(this.diff);this.diffOutOfDate=this.dealigned=!1;this.showDifferences=!1!==c.showDifferences;this.forceUpdate=ba(this);R(this,!0,!1);ca(this)},setShowDifferences:function(a){a=!1!==a;a!=this.showDifferences&&(this.showDifferences=a,this.forceUpdate("full"))}};var B=!1,F=m.MergeView=function(a,b){if(!(this instanceof F))return new F(a,b);this.options=b;var c=
b.origLeft,f=null==b.origRight?b.orig:b.origRight,e=null!=c,d=null!=f,k=1+(e?1:0)+(d?1:0),g=[],h=this.left=null,l=this.right=null,n=this;if(e){var h=this.left=new A(this,"left"),q=w("div",null,"CodeMirror-merge-pane");g.push(q);g.push(W(h))}e=w("div",null,"CodeMirror-merge-pane");g.push(e);if(d){l=this.right=new A(this,"right");g.push(W(l));var u=w("div",null,"CodeMirror-merge-pane");g.push(u)}(d?u:e).className+=" CodeMirror-merge-pane-rightmost";g.push(w("div",null,null,"height: 0; clear: both;"));
var t=this.wrap=a.appendChild(w("div",g,"CodeMirror-merge CodeMirror-merge-"+k+"pane"));this.edit=m(e,L(b));h&&h.init(q,c,b);l&&l.init(u,f,b);b.collapseIdentical&&this.editor().operation(function(){var a=b.collapseIdentical;"number"!=typeof a&&(a=2);for(var c=[],e=n.editor(),d=e.firstLine(),f=d,g=e.lastLine();f<=g;f++)c.push(!0);n.left&&Z(n.left,a,d,c);n.right&&Z(n.right,a,d,c);for(f=0;f<c.length;f++)if(c[f]){for(var g=f+d,h=1;f<c.length-1&&c[f+1];f++,h++);if(h>a){var k=[{line:g,cm:e}];n.left&&k.push({line:E(g,
n.left.chunks),cm:n.left.orig});n.right&&k.push({line:E(g,n.right.chunks),cm:n.right.orig});k=ha(h,k);if(n.options.onCollapse)n.options.onCollapse(n,g,h,k)}}});"align"==b.connect&&(this.aligners=[],H(this.left||this.right,!0));var p=function(){h&&x(h);l&&x(l)};m.on(window,"resize",p);var r=setInterval(function(){for(var a=t.parentNode;a&&a!=document.body;a=a.parentNode);a||(clearInterval(r),m.off(window,"resize",p))},5E3)};F.prototype={constuctor:F,editor:function(){return this.edit},rightOriginal:function(){return this.right&&
this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(a){this.right&&this.right.setShowDifferences(a);this.left&&this.left.setShowDifferences(a)},rightChunks:function(){if(this.right)return z(this.right),this.right.chunks},leftChunks:function(){if(this.left)return z(this.left),this.left.chunks}};var Y=new diff_match_patch;m.commands.goNextDiff=function(a){return aa(a,1)};m.commands.goPrevDiff=function(a){return aa(a,-1)}});
