'use strict';(function(h){"object"==typeof exports&&"object"==typeof module?h(require("../../lib/codemirror"),require("../../mode/sql/sql")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../../mode/sql/sql"],h):h(CodeMirror)})(function(h){function v(a){return"[object Array]"==Object.prototype.toString.call(a)}function E(a){a=a.doc.modeOption;"sql"===a&&(a="text/x-sql");return h.resolveMode(a).keywords}function u(a){return"string"==typeof a?a:a.text}function z(a,c){v(c)&&(c=
{columns:c});c.text||(c.text=a);return c}function F(a){var c={};if(v(a))for(var b=a.length-1;0<=b;b--){var d=a[b];c[u(d).toUpperCase()]=z(u(d),d)}else if(a)for(b in a)c[b.toUpperCase()]=z(b,a[b]);return c}function A(a){var c={},b;for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}function B(a,c){var b=a.length,b=u(c).substr(0,b);return a.toUpperCase()===b.toUpperCase()}function q(a,c,b,d){if(v(b))for(var f=0;f<b.length;f++)B(c,b[f])&&a.push(d(b[f]));else for(f in b)if(b.hasOwnProperty(f)){var e=
b[f],e=e&&!0!==e?e.displayText?{text:e.text,displayText:e.displayText}:e.text:f;B(c,e)&&a.push(d(e))}}function G(a){"."==a.charAt(0)&&(a=a.substr(1));return a.replace(/`/g,"")}function w(a){for(var c=u(a).split("."),b=0;b<c.length;b++)c[b]="`"+c[b]+"`";c=c.join(".");if("string"==typeof a)return c;a=A(a);a.text=c;return a}function H(a,c,b,d){for(var f=!1,e=[],r=c.start,k=!0;k;)k="."==c.string.charAt(0),f=f||"`"==c.string.charAt(0),r=c.start,e.unshift(G(c.string)),c=d.getTokenAt(n(a.line,c.start)),
"."==c.string&&(k=!0,c=d.getTokenAt(n(a.line,c.start)));a=e.join(".");q(b,a,p,function(a){return f?w(a):a});q(b,a,l,function(a){return f?w(a):a});a=e.pop();var g=e.join("."),t=!1,m=g;p[g.toUpperCase()]||(e=g,g=C(g,d),g!==e&&(t=!0));(d=p[g.toUpperCase()])&&d.columns&&(d=d.columns);d&&q(b,a,d,function(a){var b=g;1==t&&(b=m);"string"==typeof a?a=b+"."+a:(a=A(a),a.text=b+"."+a.text);return f?w(a):a});return r}function I(a,c){if(a)for(var b=/[,;]/g,d=a.split(" "),f=0;f<d.length;f++)c(d[f]?d[f].replace(b,
""):"")}function D(a){return a.line+a.ch/Math.pow(10,6)}function C(a,c){for(var b=c.doc,d=b.getValue(),f=a.toUpperCase(),e="",r="",k=[],g=n(0,0),t=n(c.lastLine(),c.getLineHandle(c.lastLine()).length),m=d.indexOf(x.QUERY_DIV);-1!=m;)k.push(b.posFromIndex(m)),m=d.indexOf(x.QUERY_DIV,m+1);k.unshift(n(0,0));k.push(n(c.lastLine(),c.getLineHandle(c.lastLine()).text.length));for(var m=0,l=D(c.getCursor()),d=0;d<k.length;d++){var h=D(k[d]);if(l>m&&l<=h){g=n(Math.floor(m),+m.toString().split(".").pop());t=
n(Math.floor(h),+h.toString().split(".").pop());break}m=h}b=b.getRange(g,t,!1);for(d=0;d<b.length&&(I(b[d],function(a){var b=a.toUpperCase();b===f&&p[e.toUpperCase()]&&(r=e);b!==x.ALIAS_KEYWORD&&(e=a)}),!r);d++);return r}var p,l,y,x={QUERY_DIV:";",ALIAS_KEYWORD:"AS"},n=h.Pos;h.registerHelper("hint","sql",function(a,c){p=F(c&&c.tables);var b=c&&c.defaultTable,d=c&&c.disableKeywords;l=b&&p[b.toUpperCase()];y=y||E(a);b&&!l&&(l=C(b,a));l=l||[];l.columns&&(l=l.columns);var b=a.getCursor(),f=[],e=a.getTokenAt(b),
h,k,g;e.end>b.ch&&(e.end=b.ch,e.string=e.string.slice(0,b.ch-e.start));e.string.match(/^[.`\w@]\w*$/)?(g=e.string,h=e.start,k=e.end):(h=k=b.ch,g="");"."==g.charAt(0)||"`"==g.charAt(0)?h=H(b,e,f,a):(q(f,g,p,function(a){return a}),q(f,g,l,function(a){return a}),d||q(f,g,y,function(a){return a.toUpperCase()}));return{list:f,from:n(b.line,h),to:n(b.line,k)}})});
